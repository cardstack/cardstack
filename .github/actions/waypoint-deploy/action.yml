name: Waypoint Deploy
description: Deploy waypoint app

inputs:
  app:
    description: Name of the app, specified in waypoint.hcl
    required: true
  retain:
    description: Number of deployments to retain
    required: false
    default: "1"
  waypoint_version:
    description: Waypoint version to use
    required: false
    default: "0.11.3"
  environment:
    description: Deployment environment
    required: true
  discord_webhook:
    description: Discord webhook URL
    required: true

runs:
  using: composite
  steps:
    - uses: ./.github/actions/init

    - uses: lucasmelin/setup-waypoint@v1
      with:
        version: ${{ inputs.waypoint_version }}

    - name: Build ${{ inputs.app }}
      run: waypoint build -app=${{ inputs.app }} -plain -push
      shell: bash
      env:
        WAYPOINT_SERVER_TLS: "1"

    - name: Deploy app
      shell: bash
      run: waypoint deploy -app=${{ inputs.app }} -plain -local -release=false
      env:
        WAYPOINT_SERVER_TLS: "1"

    - name: Add tags
      uses: cardstack/gh-actions/waypoint-ecs-add-tags@main
      with:
        app: ${{ inputs.app }}
        environment: ${{ inputs.environment }}

    - name: Wait service stable
      uses: cardstack/gh-actions/waypoint-wait-service-stable@main
      with:
        app: ${{ inputs.app }}
        waypoint-hcl: ${{ inputs.working-directory }}/waypoint.hcl

    - name: Release app
      shell: bash
      run: waypoint release -app=${{ inputs.app }} -prune=false -plain -local
      env:
        WAYPOINT_SERVER_TLS: "1"

    - name: Prune old resources
      uses: cardstack/gh-actions/waypoint-ecs-prune@main
      with:
        app: ${{ inputs.app }}
        environment: ${{ inputs.environment }}

    - name: Send notification to Discord
      if: ${{ always() }}
      uses: ./.github/actions/discord-notification-deploy
      with:
        app: ${{ inputs.app }}
        status: ${{ github.action_status }}
        environment: ${{ inputs.environment }}
        webhook: ${{ inputs.discord_webhook }}
        is_ecs: "true"
