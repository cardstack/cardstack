<Boxel::Thread class="workflow-thread" tabindex="0" {{did-insert this.focus}} data-test-workflow-thread ...attributes>
  <:header>
    <Boxel::ThreadHeader @title={{@workflow.name}} />
  </:header>
  <:content>
    {{#if (has-block 'before-content')}}
      {{yield to='before-content'}}
    {{/if}}
      {{#each @workflow.visibleMilestones as |milestone i|}}
        {{#each milestone.visiblePostables as |postable j|}}
          <WorkflowThread::Postable
            @postable={{postable}}
            @previous={{object-at milestone.visiblePostables (dec j)}}
            @frozen={{or @workflow.isComplete @workflow.isCanceled}}
            @index={{j}}
            data-test-milestone={{i}}
          />
        {{/each}}
        {{#if milestone.isComplete}}
          <Boxel::MilestoneBanner
            @title={{milestone.completedDetail}}
            @status={{if (eq i (dec @workflow.milestones.length)) "Workflow completed" "Milestone reached"}}
            data-milestone={{i}}
            data-test-milestone-completed
            data-test-milestone={{i}}
          />
        {{/if}}
      {{/each}}
    {{#if @workflow.isComplete}}
      {{#each @workflow.epilogue.visiblePostables as |postable j|}}
        <WorkflowThread::Postable
          @postable={{postable}}
          @previous={{object-at @workflow.epilogue.visiblePostables (dec j)}}
          @index={{j}}
          data-test-epilogue
        />
      {{/each}}
    {{else if @workflow.isCanceled}}
      {{#each @workflow.cancelationMessages.visiblePostables as |postable j|}}
         <WorkflowThread::Postable
           {{did-insert this.scrollToEnd}}
           @postable={{postable}}
           @previous={{if (eq j 0) this.lastMilestonePostable (object-at @workflow.cancelationMessages.visiblePostables (dec j))}}
           @index={{j}}
           data-test-cancelation
         />
      {{/each}}
    {{/if}}
    <div data-thread-end></div>
  </:content>
  <:sidebar as |SidebarSection|>
    <SidebarSection>
      <Boxel::Sidebar::CardContainer
        @header={{html-safe (concat "Workflow:<br>" @workflow.name)}}
        @attachNext={{true}}
      >
        <div>
          <Boxel::ProgressCircle
            @percentComplete={{percent-complete
              total=@workflow.milestones.length
              completed=@workflow.completedMilestoneCount
            }}
          />
        </div>
        <div class="workflow-thread__status">
          {{if @workflow.isCanceled "Workflow canceled" @workflow.progressStatus}}
        </div>
      </Boxel::Sidebar::CardContainer>

      <Boxel::Sidebar::CardContainer @header="Milestones">
        <Boxel::ProgressSteps
          @progressSteps={{@workflow.milestones}}
          @completedCount={{@workflow.completedMilestoneCount}}
          @onClickStep={{this.scrollMilestoneIntoView}}
        />
      </Boxel::Sidebar::CardContainer>
    </SidebarSection>
  </:sidebar>
</Boxel::Thread>